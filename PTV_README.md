# ТЕХНИЧЕСКОЕ ЗАДАНИЕ

## Модуль трассерной визуализации частиц (PTV)

---

## 1. Входные данные

### 1.1. Структура директорий

На вход модуля подаётся директория эксперимента с бинаризованными 8-битными изображениями. Структура входных данных:

```
binary_filter_XXXX/
├── cam_1/
│   ├── 1_a.png
│   ├── 1_b.png
│   ├── 2_a.png
│   ├── 2_b.png
│   └── ...
└── cam_2/
    ├── 1_a.png
    ├── 1_b.png
    ├── 2_a.png
    ├── 2_b.png
    └── ...
```

Где `XXXX` — значение порога бинаризации (например, `binary_filter_10000`).

Именование файлов соответствует шаблону: `N_X.png`, где:
- `N` — номер пары кадров (1, 2, 3, ...)
- `X` — идентификатор кадра в паре (`a` — первый кадр, `b` — второй кадр после временного интервала Δt)

### 1.2. Требования к изображениям

| Параметр | Требование |
|----------|------------|
| Формат файла | PNG |
| Глубина цвета | 8 бит |
| Тип изображения | Бинаризованное (чёрно-белое) |
| Фон | Чёрный (значение 0) |
| Частицы | Белые (значение 255) |

---

## 2. Функциональные требования

### 2.1. Модуль детектирования частиц

Модуль выполняет обнаружение и измерение геометрических параметров частиц на бинаризованных изображениях.

#### 2.1.1. Алгоритм обработки

1. Загрузка бинаризованного изображения (на вход подаётся уже обработанное бинарным фильтром изображение)
2. Поиск связных компонент с использованием 4-связности
3. Фильтрация по площади (min_area ≤ S ≤ max_area)
4. Расчёт геометрических параметров каждой частицы

**Пояснение к 4-связности:**

4-связность означает, что при поиске связных компонент (групп пикселей, принадлежащих одной частице) учитываются только 4 соседних пикселя по сторонам: сверху, снизу, слева и справа. Диагональные соседи не учитываются.

```
┌───┬───┬───┐
│   │ 1 │   │
├───┼───┼───┤
│ 2 │ X │ 3 │
├───┼───┼───┤
│   │ 4 │   │
└───┴───┴───┘
```

Для пикселя X соседними считаются только пиксели 1, 2, 3, 4.

#### 2.1.2. Выходные параметры частиц

| Параметр | Единица измерения | Описание |
|----------|-------------------|----------|
| ID | — | Уникальный идентификатор частицы |
| Площадь | пиксели | Площадь связной области |
| Центр X | пиксели | X-координата центра масс |
| Центр Y | пиксели | Y-координата центра масс |
| Диаметр | пиксели | Эквивалентный диаметр: D = 2√(S/π) |

**Пояснение к центру масс:**

Центр масс (центроид) частицы — это средневзвешенная координата всех пикселей, принадлежащих данной частице. Для бинарного изображения, где все пиксели частицы имеют одинаковую яркость, центр масс вычисляется как среднее арифметическое координат:

```
Центр X = (x₁ + x₂ + ... + xₙ) / n
Центр Y = (y₁ + y₂ + ... + yₙ) / n
```

Где `n` — количество пикселей в частице, `(x₁, y₁), (x₂, y₂), ..., (xₙ, yₙ)` — координаты каждого пикселя частицы.

**Пример:**

Если частица состоит из 4 пикселей с координатами (10, 20), (11, 20), (10, 21), (11, 21):

```
Центр X = (10 + 11 + 10 + 11) / 4 = 10.5
Центр Y = (20 + 20 + 21 + 21) / 4 = 20.5
```

Центр масс позволяет определить положение частицы с субпиксельной точностью, что важно для точного расчёта векторов смещения.

---

### 2.2. Модуль сопоставления частиц

Модуль выполняет сопоставление частиц между последовательными кадрами для определения векторов смещения.

#### 2.2.1. Логика сопоставления кадров

Сопоставление выполняется **внутри каждой камеры** между парой кадров `a` и `b`:

**Для cam_1:**
- Кадр `1_a.png` сопоставляется с кадром `1_b.png` → результат `1_pair.csv`
- Кадр `2_a.png` сопоставляется с кадром `2_b.png` → результат `2_pair.csv`
- И так далее...

**Для cam_2:**
- Кадр `1_a.png` сопоставляется с кадром `1_b.png` → результат `1_pair.csv`
- Кадр `2_a.png` сопоставляется с кадром `2_b.png` → результат `2_pair.csv`
- И так далее...

Кадр `a` — положение частиц в момент времени t₀.  
Кадр `b` — положение тех же частиц в момент времени t₀ + Δt.

Сопоставление определяет, какая частица на кадре `a` соответствует какой частице на кадре `b`, и вычисляет вектор смещения.

#### 2.2.2. Алгоритм сопоставления

Применяется метод One-to-One matching с использованием KD-дерева для ускорения поиска ближайших соседей:

1. Построение KD-дерева по координатам частиц кадра `b`
2. Для каждой частицы кадра `a` поиск кандидатов в радиусе `max_distance`
3. Фильтрация по разнице диаметров: |D_a - D_b| ≤ max_diameter_diff
4. Выбор лучшего кандидата по комбинированной метрике: `score = dist + Δd × 5`
5. Исключение использованных частиц (каждая частица может быть сопоставлена только один раз)

#### 2.2.3. Выходные параметры пар

| Параметр | Единица | Описание |
|----------|---------|----------|
| ID | — | Идентификатор сопоставленной пары |
| X0, Y0 | пиксели | Координаты частицы в кадре `a` |
| dx, dy | пиксели | Компоненты вектора смещения |
| L | пиксели | Модуль вектора смещения: L = √(dx² + dy²) |
| Диаметр | пиксели | Диаметр частицы (из кадра `a`) |
| Площадь | пиксели | Площадь частицы (из кадра `a`) |

---

## 3. Конфигурационные параметры

### 3.1. Параметры детектирования частиц

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| min_area | int | 4 | Минимальная площадь частицы (пикс.) |
| max_area | int | 150 | Максимальная площадь частицы (пикс.) |

### 3.2. Параметры сопоставления

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| max_distance | float | 30 | Максимальный радиус поиска соответствия (пикс.) |
| max_diameter_diff | float | 2.0 | Максимальная допустимая разница диаметров (пикс.) |

---

## 4. Выходные данные

### 4.1. Структура выходных директорий

Папка с результатами PTV-анализа создаётся **рядом** с входной папкой бинаризованных изображений.

**Пример:**

Входная папка:
```
C:\...\test_data_cam_sorted\binary_filter_10000\
```

Выходная папка создаётся в:
```
C:\...\test_data_cam_sorted\PTV_10000\
```

Имя выходной папки формируется как `PTV_XXXX`, где `XXXX` — значение порога из имени входной папки `binary_filter_XXXX`.

**Полная структура выходных данных:**

```
test_data_cam_sorted/
├── binary_filter_10000/          # Входная папка (не изменяется)
│   ├── cam_1/
│   └── cam_2/
│
└── PTV_10000/                    # Выходная папка с результатами
    ├── cam_1/                    # Детектированные частицы cam_1
    │   ├── 1_a.csv
    │   ├── 1_b.csv
    │   ├── 2_a.csv
    │   ├── 2_b.csv
    │   └── ...
    ├── cam_2/                    # Детектированные частицы cam_2
    │   ├── 1_a.csv
    │   ├── 1_b.csv
    │   ├── 2_a.csv
    │   ├── 2_b.csv
    │   └── ...
    ├── cam_1_pairs/              # Результаты сопоставления cam_1
    │   ├── 1_pair.csv
    │   ├── 2_pair.csv
    │   └── ...
    └── cam_2_pairs/              # Результаты сопоставления cam_2
        ├── 1_pair.csv
        ├── 2_pair.csv
        └── ...
```

### 4.2. Формат CSV-файлов

Все CSV-файлы используют:
- Разделитель: `;` (точка с запятой)
- Кодировка: UTF-8
- Первая строка: заголовки столбцов

---

## 5. Обработка ошибок

| Ситуация | Поведение модуля |
|----------|------------------|
| Файл изображения не найден | ValueError с указанием пути |
| Повреждённый файл изображения | ValueError с сообщением об ошибке загрузки |
| Пустой CSV-файл | RuntimeError с указанием файла |
| Отсутствует парный файл (a/b) | Warning, пара пропускается, обработка продолжается |
| Частицы не обнаружены | Создаётся пустой CSV с заголовками |
