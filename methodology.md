# Методика обработки изображений капель методом трассерной визуализации частиц

## 1. Общее описание методики

Для количественного исследования динамики капель разработан программный комплекс, реализующий полный цикл обработки экспериментальных изображений методом трассерной визуализации частиц (Particle Tracking Velocimetry, PTV). Методика включает последовательное выполнение пяти этапов: предварительную обработку исходных изображений (сортировку и бинаризацию), детектирование частиц, попарное сопоставление частиц между последовательными кадрами, фильтрацию полученных векторов перемещений, а также усреднение по регулярной сетке и визуализацию результирующего векторного поля. Программный комплекс реализован на языке Python с использованием библиотек NumPy, SciPy, OpenCV и Matplotlib; графический интерфейс построен на основе фреймворка PyQt5.

## 2. Предварительная обработка изображений

### 2.1. Сортировка по камерам

Исходные данные представляют собой набор 16-битных полутоновых изображений в формате PNG с диапазоном яркости 0--65535, полученных с двух синхронизированных камер. Изображения с обеих камер записываются в единый каталог с чередующейся последовательностью, в которой каждые четыре кадра образуют один цикл съемки. Первые два кадра цикла (позиции 0 и 1) соответствуют камере 1 и представляют собой пару кадров *a* и *b*, разделенных временным интервалом $\Delta t$. Аналогично, кадры на позициях 2 и 3 соответствуют камере 2. Общее количество изображений должно быть кратно четырем.

В процессе сортировки изображения разделяются по принадлежности к соответствующей камере и переименовываются в формат $N\_a$ и $N\_b$, где $N$ -- порядковый номер пары кадров. Для изображений камеры 1 дополнительно выполняется горизонтальное зеркальное отражение, что обусловлено оптической схемой экспериментальной установки.

### 2.2. Бинаризация

Бинаризация выполняется пороговым методом одновременно с сортировкой за один проход по массиву данных. Для каждого пикселя исходного 16-битного изображения применяется пороговое преобразование:

$$
I_{bin}(x, y) = \begin{cases}
255, & \text{если } I(x, y) \geq T \\
0, & \text{если } I(x, y) < T
\end{cases}
$$

где $I(x, y)$ -- яркость пикселя исходного изображения, $T$ -- порог бинаризации, задаваемый пользователем, $I_{bin}(x, y)$ -- яркость пикселя результирующего 8-битного изображения. Типичное значение порога бинаризации составляет $T = 2000$, что соответствует уровню шума сенсора используемых камер. Результатом данного этапа являются 8-битные бинарные изображения, в которых области частиц представлены белыми пикселями (255), а фон -- черными (0).

## 3. Детектирование частиц

### 3.1. Метод связных компонент

Идентификация отдельных частиц на бинарных изображениях осуществляется методом анализа связных компонент с 4-связностью. При таком подходе два белых пикселя считаются принадлежащими одной компоненте, если они являются соседними по горизонтали или вертикали; диагональные соседи не учитываются. Ядро связности имеет вид:

$$
S = \begin{pmatrix}
0 & 1 & 0 \\
1 & 1 & 1 \\
0 & 1 & 0
\end{pmatrix}
$$

Каждая выделенная связная область идентифицируется как отдельная частица-кандидат.

### 3.2. Вычисление параметров частиц

Для каждой обнаруженной связной компоненты вычисляются три основных параметра. Площадь $A$ определяется как количество пикселей, принадлежащих компоненте. Координаты центра масс $(X_c, Y_c)$ рассчитываются как среднее арифметическое координат всех пикселей компоненты:

$$
X_c = \frac{1}{A} \sum_{i=1}^{A} x_i, \quad Y_c = \frac{1}{A} \sum_{i=1}^{A} y_i
$$

Эквивалентный диаметр $D$ определяется как диаметр круга, площадь которого равна площади компоненты:

$$
D = 2\sqrt{\frac{A}{\pi}}
$$

### 3.3. Фильтрация детектированных объектов

Для исключения шумовых объектов и артефактов изображения выполняется фильтрация по площади. Компоненты, площадь которых выходит за пределы допустимого диапазона $A_{min} \leq A \leq A_{max}$, отбрасываются. Нижний порог $A_{min}$ (типичное значение -- 4 пикселя) позволяет исключить одиночные шумовые пиксели и мелкие кластеры, не являющиеся реальными частицами. Верхний порог $A_{max}$ (типичное значение -- 150 пикселей) отсекает крупные агломераты частиц и оптические артефакты.

## 4. Сопоставление частиц между кадрами

### 4.1. Постановка задачи

Для каждой пары последовательных кадров (*a*, *b*) решается задача установления взаимно однозначного соответствия между детектированными частицами. Частице, обнаруженной в кадре *a* в момент времени $t_0$, ставится в соответствие частица в кадре *b*, зарегистрированная в момент $t_0 + \Delta t$. Применяется ограничение "один к одному": каждая частица может участвовать не более чем в одной паре, что исключает неоднозначные сопоставления.

### 4.2. Алгоритм сопоставления

Для эффективного поиска кандидатов используется пространственная индексация на основе KD-дерева, построенного по координатам центров масс частиц кадра *b*. Алгоритм сопоставления состоит из четырех шагов.

На первом шаге для каждой частицы $p_a$ кадра *a* выполняется запрос к KD-дереву с целью нахождения всех частиц кадра *b*, расположенных в пределах радиуса поиска $r_{max}$.

На втором шаге из найденных кандидатов отбираются те, для которых разность эквивалентных диаметров не превышает заданного порога:

$$
|D_a - D_b| \leq \Delta D_{max}
$$

На третьем шаге для каждого допустимого кандидата вычисляется комбинированная функция качества сопоставления:

$$
S = d(p_a, p_b) + 5 \cdot |D_a - D_b|
$$

где $d(p_a, p_b) = \sqrt{(x_a - x_b)^2 + (y_a - y_b)^2}$ -- евклидово расстояние между центрами масс частиц. Весовой коэффициент при разности диаметров обеспечивает приоритет сопоставления частиц близкого размера, что повышает робастность алгоритма в областях с высокой концентрацией частиц.

На четвертом шаге выбирается кандидат с минимальным значением функции $S$. Если данный кандидат уже был сопоставлен с другой частицей кадра *a* на предыдущих итерациях, он пропускается, и рассматривается следующий по рангу кандидат.

Типичные значения параметров сопоставления: максимальное расстояние поиска $r_{max} = 50{,}0$ пикселей, максимальная допустимая разность диаметров $\Delta D_{max} = 4{,}0$ пикселя.

### 4.3. Вычисление вектора перемещения

Для каждой сопоставленной пары частиц вычисляются компоненты вектора перемещения как разность координат центров масс:

$$
dx = X_b - X_a, \quad dy = Y_b - Y_a
$$

а также модуль вектора перемещения:

$$
L = \sqrt{dx^2 + dy^2}
$$

Результаты сопоставления сохраняются в формате табличных данных с разделителем "точка с запятой". Для каждой пары кадров формируется отдельный файл, содержащий координаты начальной позиции частицы $(X_0, Y_0)$, компоненты перемещения $(dx, dy)$, модуль вектора $L$, а также эквивалентный диаметр и площадь частицы. Помимо попарных файлов, формируется суммарный файл для каждой камеры, объединяющий данные по всем обработанным парам кадров. Имя выходного каталога кодирует все ключевые параметры анализа: порог бинаризации, границы площади, радиус поиска и допустимую разность диаметров.

## 5. Фильтрация векторов перемещений

Этап фильтрации предназначен для удаления ошибочных сопоставлений, которые проявляются как аномальные значения компонент вектора перемещения. Подобные выбросы возникают при неверном сопоставлении частиц, находящихся вблизи границы области поиска, либо при сопоставлении реальных частиц с шумовыми объектами.

Фильтрация выполняется по допустимым диапазонам компонент вектора перемещения. Вектор считается допустимым и сохраняется в результирующем наборе данных, если одновременно выполняются условия:

$$
U_{min} \leq dx \leq U_{max}, \quad V_{min} \leq dy \leq V_{max}
$$

При нарушении хотя бы одного из условий вектор исключается из набора данных. Диапазоны фильтрации задаются пользователем исходя из физических ожиданий о характере исследуемого течения. Типичные значения для экспериментов с каплями составляют $dx \in [0, 40]$ пикселей (горизонтальная компонента, соответствующая направлению движения капель) и $dy \in [-10, 10]$ пикселей (вертикальная компонента, ограниченная ввиду преимущественно горизонтального характера движения). Дополнительно может быть активирована фильтрация по модулю вектора $L$.

Результат фильтрации сохраняется в табличном файле того же формата, что и входные данные. В имя выходного файла автоматически включается процент удаленных векторов, что позволяет оперативно оценить долю отбракованных данных без дополнительного анализа.

## 6. Усреднение векторного поля по регулярной сетке

### 6.1. Назначение

Результатом предыдущих этапов обработки является дискретный набор индивидуальных векторов перемещений, привязанных к нерегулярно расположенным центрам масс частиц. Для перехода к регулярному полю скоростей, пригодному для визуализации и дальнейшего количественного анализа, выполняется пространственное усреднение по ячейкам прямоугольной сетки.

### 6.2. Построение сетки и усреднение

На плоскости изображения строится регулярная прямоугольная сетка, параметры которой задаются пользователем. Количество ячеек сетки по каждому направлению определяется как:

$$
n_x = \left\lceil \frac{W}{w_c} \right\rceil, \quad n_y = \left\lceil \frac{H}{h_c} \right\rceil
$$

где $W \times H$ -- размер плоскости изображения в пикселях, $w_c \times h_c$ -- размер одной ячейки. Для каждого вектора перемещения по координатам его начальной точки $(X_0, Y_0)$ определяется принадлежность к ячейке сетки:

$$
i_x = \left\lfloor \frac{X_0 - X_{origin}}{w_c} \right\rfloor, \quad i_y = \left\lfloor \frac{Y_0 - Y_{origin}}{h_c} \right\rfloor
$$

где $(X_{origin}, Y_{origin})$ -- координаты начала отсчета сетки. В пределах каждой ячейки выполняется арифметическое усреднение компонент перемещения:

$$
\overline{dx} = \frac{1}{N_c} \sum_{k=1}^{N_c} dx_k, \quad \overline{dy} = \frac{1}{N_c} \sum_{k=1}^{N_c} dy_k
$$

где $N_c$ -- количество векторов, попавших в данную ячейку. Модуль усредненного вектора вычисляется по усредненным компонентам:

$$
\overline{L} = \sqrt{\overline{dx}^2 + \overline{dy}^2}
$$

Результирующие усредненные векторы привязываются к геометрическим центрам соответствующих ячеек:

$$
X_c = X_{origin} + (i_x + 0.5) \cdot w_c, \quad Y_c = Y_{origin} + (i_y + 0.5) \cdot h_c
$$

Ячейки, содержащие менее $N_{min}$ точек, исключаются из результирующего набора данных. Типичный размер ячейки составляет $66 \times 66$ пикселей при размере изображения $4904 \times 3280$ пикселей, что обеспечивает достаточную пространственную детализацию при сохранении статистической значимости усредненных значений.

## 7. Визуализация результатов

Визуализация усредненного поля перемещений выполняется в виде векторной диаграммы (quiver plot). Каждый усредненный вектор отображается стрелкой, начало которой расположено в центре соответствующей ячейки сетки, а направление и длина пропорциональны компонентам $\overline{dx}$ и $\overline{dy}$. Масштаб отображения стрелок регулируется параметром масштабирования, что позволяет адаптировать визуализацию к конкретному диапазону скоростей.

Цвет стрелок кодирует выбранную скалярную характеристику поля. По умолчанию используется модуль перемещения $\overline{L}$; альтернативно возможно кодирование по отдельным компонентам $\overline{dx}$, $\overline{dy}$ или по углу направления вектора $\theta = \text{atan2}(\overline{dy}, \overline{dx})$. Отображение выполняется с использованием одной из стандартных цветовых шкал. Ось ординат по умолчанию инвертирована для соответствия системе координат изображения, в которой начало отсчета расположено в левом верхнем углу.

Результирующее изображение сохраняется в растровом формате PNG с разрешением 150 DPI, что обеспечивает качество, достаточное для включения в публикации. Дополнительно поддерживаются форматы SVG и PDF для получения векторной графики.

## 8. Параметры обработки

Совокупность параметров, определяющих работу всех этапов обработки, приведена в Таблице 1. Значения по умолчанию подобраны на основе серии предварительных экспериментов и обеспечивают устойчивую работу алгоритмов для типичных условий съемки.

**Таблица 1.** Параметры обработки изображений капель методом PTV.

| Этап обработки | Параметр | Обозначение | Значение по умолчанию |
|---|---|---|---|
| Бинаризация | Порог яркости | $T$ | 2000 |
| Детектирование | Минимальная площадь частицы | $A_{min}$ | 4 пикс. |
| Детектирование | Максимальная площадь частицы | $A_{max}$ | 150 пикс. |
| Сопоставление | Радиус поиска кандидатов | $r_{max}$ | 50,0 пикс. |
| Сопоставление | Допустимая разность диаметров | $\Delta D_{max}$ | 4,0 пикс. |
| Фильтрация | Диапазон горизонтальной компоненты | $dx$ | [0; 40] пикс. |
| Фильтрация | Диапазон вертикальной компоненты | $dy$ | [--10; 10] пикс. |
| Усреднение | Размер ячейки сетки | $w_c \times h_c$ | 66 $\times$ 66 пикс. |
| Усреднение | Минимальное число точек в ячейке | $N_{min}$ | 1 |
